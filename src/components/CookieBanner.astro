---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { ShieldCheck, ChevronDown, Check, X, Cookie } from 'lucide-astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div id="cookie-banner" class="fixed bottom-6 left-6 right-6 z-[9999] pointer-events-none transform translate-y-full opacity-0 transition-all duration-700 ease-out">
  <div class="max-w-4xl mx-auto pointer-events-auto">
    <div class="glass rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.15)] border border-white/40 overflow-hidden relative">
      <!-- Decoration -->
      <div class="absolute -top-24 -right-24 w-48 h-48 bg-accent/5 rounded-full blur-3xl pointer-events-none"></div>
      
      <div class="p-6 md:p-8">
        <div class="flex flex-col md:flex-row gap-8 items-start">
          <!-- Icon & Info -->
          <div class="flex-1">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl bg-accent/10 flex items-center justify-center text-accent">
                <Cookie size={24} />
              </div>
              <h2 class="text-xl font-black text-primary uppercase tracking-tight italic">
                {t('cookies.banner.title')}
              </h2>
            </div>
            <p class="text-slate-600 text-sm md:text-base leading-relaxed max-w-2xl">
              {t('cookies.banner.desc')}
            </p>
            
            <!-- Settings Dropdown -->
            <div id="cookie-settings" class="hidden mt-8 space-y-4 border-t border-slate-100 pt-6 animate-in slide-in-from-top-4 duration-500">
              <div class="grid md:grid-cols-2 gap-4">
                <!-- Essential -->
                <div class="p-4 rounded-2xl bg-slate-50 border border-slate-100 flex gap-4">
                  <div class="flex-1">
                    <h3 class="font-bold text-primary text-sm mb-1">{t('cookies.settings.essential.title')}</h3>
                    <p class="text-xs text-slate-500 leading-tight">{t('cookies.settings.essential.desc')}</p>
                  </div>
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded bg-accent text-white flex items-center justify-center shadow-lg shadow-accent/20">
                      <Check size={14} />
                    </div>
                    <span class="text-[10px] font-bold text-accent uppercase tracking-tighter">On</span>
                  </div>
                </div>
                
                <!-- Marketing -->
                <div class="p-4 rounded-2xl bg-slate-100/50 border border-slate-100 flex gap-4 opacity-60">
                  <div class="flex-1">
                    <h3 class="font-bold text-slate-400 text-sm mb-1">{t('cookies.settings.marketing.title')}</h3>
                    <p class="text-xs text-slate-400 leading-tight">{t('cookies.settings.marketing.desc')}</p>
                  </div>
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded border-2 border-slate-300 text-slate-300 flex items-center justify-center">
                      <X size={14} />
                    </div>
                    <span class="text-[10px] font-bold text-slate-300 uppercase tracking-tighter">Off</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex flex-col gap-3 w-full md:w-auto md:min-w-[200px]">
            <button id="cookie-accept" class="w-full px-6 py-4 bg-primary text-white rounded-2xl font-bold hover:bg-black transition-colors shadow-xl shadow-primary/10 text-sm uppercase tracking-wide">
              {t('cookies.banner.accept')}
            </button>
            <div class="flex items-center gap-3">
              <button id="cookie-decline" class="flex-1 px-4 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:border-accent hover:text-accent transition-all text-xs uppercase tracking-wide">
                {t('cookies.banner.decline')}
              </button>
              <button id="toggle-settings" class="px-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition-colors flex items-center gap-2 text-xs uppercase tracking-wide">
                <span>{t('cookies.banner.settings')}</span>
                <ChevronDown size={14} id="settings-chevron" class="transition-transform" />
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function initCookieBanner() {
    const banner = document.getElementById('cookie-banner');
    const acceptBtn = document.getElementById('cookie-accept');
    const declineBtn = document.getElementById('cookie-decline');
    const settingsBtn = document.getElementById('toggle-settings');
    const settingsPanel = document.getElementById('cookie-settings');
    const chevron = document.getElementById('settings-chevron');
    
    if (!banner || !acceptBtn || !declineBtn || !settingsBtn || !settingsPanel || !chevron) return;

    // Check if user has already made a choice
    const cookieChoice = localStorage.getItem('cookie-consent');
    if (!cookieChoice) {
      setTimeout(() => {
        banner.classList.remove('translate-y-full', 'opacity-0');
      }, 1500);
    }

    function hideBanner() {
      banner.classList.add('translate-y-full', 'opacity-0');
    }

    acceptBtn.addEventListener('click', () => {
      localStorage.setItem('cookie-consent', 'all');
      hideBanner();
    });

    declineBtn.addEventListener('click', () => {
      localStorage.setItem('cookie-consent', 'necessary');
      hideBanner();
    });

    settingsBtn.addEventListener('click', () => {
      settingsPanel.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    });
  }

  // Handle both initial load and view transitions
  initCookieBanner();
  document.addEventListener('astro:after-swap', initCookieBanner);
</script>

<style>
  .glass {
    backdrop-filter: blur(20px);
    background: rgba(255, 255, 255, 0.85);
  }
</style>
